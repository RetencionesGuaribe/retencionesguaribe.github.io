<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de Órdenes de Compra Editable</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
        }

        .container-a4 {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 10mm 15mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            box-sizing: border-box;
        }

        .header {
            position: relative;
            height: 90px;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 2px solid #000;
        }

        .header-logo {
            position: absolute;
            height: 50px;
            width: auto;
            top: 5px;
            z-index: 1;
        }

        .header-logo:first-child {
            left: 10px;
        }

        .header-logo:last-child {
            right: 10px;
            height: 50px;
            top: 5px;
        }

        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            text-align: center;
            top: 2px;
            font-size: 12pt;
            line-height: 1.1;
        }

        .header h2 {
            font-size: 12px;
            margin: 1px 0;
        }

        .header h3, .header p {
            font-size: 12px;
            margin: 1px 0;
        }

        .content-container {
            font-size: 10pt;
            line-height: 1.3;
            height: calc(297mm - 120px);
            box-sizing: border-box;
        }

        input, select, textarea {
            width: 100%;
            padding: 1mm;
            margin: 1mm 0;
            border: 1px solid #ddd;
            font-size: 10pt;
            box-sizing: border-box;
        }

        .tabla-productos {
            width: 100%;
            border-collapse: collapse;
            margin: 2mm 0;
            font-size: 9pt;
        }

        .tabla-productos td, .tabla-productos th {
            border: 1px solid #ddd;
            padding: 1mm;
            height: 5mm;
        }

        .firmas-section {
            display: flex;
            justify-content: space-between;
            margin-top: 10mm;
            padding-top: 5mm;
            border-top: 1px solid #000;
        }

        .firmas-section > div {
            width: 45%;
            padding: 1mm;
            font-size: 9pt;
        }

        .boton-edicion {
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            font-size: 10pt;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .fecha-header {
            text-align: right;
            margin-bottom: 3mm;
            font-size: 10pt;
        }

        @media print {
            body {
                background: none;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .container-a4 {
                padding: 5mm 10mm;
                box-shadow: none;
                min-height: 297mm;
                page-break-after: always;
            }
            
            .header {
                height: 80px;
                margin-bottom: 5px;
            }
            
            .header-logo {
                height: 40px;
            }
            
            .header-center {
                font-size: 10pt;
            }
            
            .content-container {
                font-size: 9pt;
                height: calc(297mm - 90px);
            }
            
            input, textarea {
                border: none;
                padding: 0;
                margin: 0;
            }
            
            .tabla-productos {
                font-size: 8pt;
            }
            
            .no-print {
                display: none;
            }
            
            .firmas-section {
                margin-top: 8mm;
            }
        }
    </style>
</head>
<body>
    <div class="container-a4">
        <div class="header">
            <img src="images/logo.png" alt="Escudo" class="header-logo">
            <div class="header-center">
                <h2>REPÚBLICA BOLIVARIANA DE VENEZUELA</h2>
                <h3>ALCALDÍA BOLIVARIANA DEL MUNICIPIO SAN JOSÉ DE GUARIBE</h3>
                <h3>ESTADO GUÁRICO - DIRECCIÓN DE ADMINISTRACIÓN Y FINANZAS</h3>
                <p>RIF: G-20000382-0</p>
            </div>
            <img src="images/logo1.png" alt="Bandera" class="header-logo">
        </div>

        <div class="content-container">
            <div class="fecha-header" id="fecha-input">
                San José de Guaribe, <input type="date" id="fecha-actual">
            </div>
			
			<div id="editar-index" style="display:none;"></div>

            <div id="formulario">
                <h2 style="text-align: center; margin: 2mm 0; font-size: 11pt;">
                    ORDEN DE COMPRA N° <input type="text" id="numero-orden" placeholder="000" style="width: 30px;">-<span id="ano-actual"></span>
                </h2>

                <div style="margin: 3mm 0;">
                    <p>Señores: <input type="text" id="senores" placeholder="______________________________________" 
                        style="width: 75%; border: none; border-bottom: 1px solid #000;"></p>
                    <p>Dirección: <input type="text" id="direccion-orden" placeholder="_____________________________________" 
                        style="width: 75%; border: none; border-bottom: 1px solid #000;"></p>
                </div>

                <p style="margin: 3mm 0; font-size: 10pt;"><strong>Sirvase en despachar por cuenta de esta ALCALDÍA MUNICIPAL; lo siguiente:</strong></p>

                <div style="display:flex;gap:2mm;margin:2mm 0">
    <input type="number" id="cantidad" placeholder="Cantidad" style="width:15%">
    <input type="text" id="descripcion" placeholder="Descripción" style="flex-grow:1">
    <button onclick="agregarProducto()" style="padding: 2px 5px;">➕</button>
    <button onclick="cancelarEdicion()" id="cancelar-btn" style="padding: 2px 5px; display:none;">❌ Cancelar</button>
</div>

                <table class="tabla-productos">
                    <thead>
                        <tr><th style="width:15%">Cantidad</th><th>Descripción</th><th style="width:10%">Acción</th></tr>
                    </thead>
                    <tbody id="productos-body">
                        <tr class="placeholder-row"><td colspan="3">No hay productos agregados</td></tr>
                    </tbody>
                </table>

                <div style="margin: 3mm 0;">
                    <p style="font-size: 10pt;"><strong>Los cuales serán utilizados para:</strong></p>
                    <textarea id="utilizados-para" placeholder="Describir el destino..." 
                            style="width: 100%; height: 15mm; font-size: 10pt;"></textarea>
                </div>

                <div class="no-print" style="text-align: center; margin-top: 3mm;">
                    <button onclick="generarOrden()" class="boton-edicion">Generar Orden</button>
                </div>
            </div>

            <div id="orden-generada"></div>
        </div>
    </div>

    <script>
        let productos = [];
        const fecha = new Date();
        
        document.getElementById('ano-actual').textContent = fecha.getFullYear();
        document.getElementById('fecha-actual').valueAsDate = new Date();

        function agregarProducto() {
    const cantidad = document.getElementById('cantidad').value;
    const descripcion = document.getElementById('descripcion').value.trim();
    const editarIndex = document.getElementById('editar-index').dataset.index;

    if(cantidad && descripcion) {
        if(editarIndex !== undefined) {
            // Actualizar producto existente
            productos[editarIndex] = { cantidad, descripcion };
            delete document.getElementById('editar-index').dataset.index;
            document.querySelector('[onclick="agregarProducto()"]').textContent = "➕";
        } else {
            // Agregar nuevo producto
            productos.push({cantidad, descripcion});
        }
        actualizarTabla();
        document.getElementById('cantidad').value = '';
        document.getElementById('descripcion').value = '';
        document.querySelector('[onclick="agregarProducto()"]').textContent = "➕";
    }
}

        function actualizarTabla() {
    const tbody = document.querySelector('#productos-body');
    tbody.innerHTML = productos.length > 0 
        ? productos.map((p, i) => `
            <tr>
                <td>${p.cantidad}</td>
                <td>${p.descripcion}</td>
                <td>
                    <button onclick="editar(${i})" style="padding: 2px 5px;">✏️</button>
                    <button onclick="eliminar(${i})" style="padding: 2px 5px;">❌</button>
                </td>
            </tr>`).join('')
        : '<tr class="placeholder-row"><td colspan="3">No hay productos agregados</td></tr>';
}

function editar(index) {
    const producto = productos[index];
    document.getElementById('cantidad').value = producto.cantidad;
    document.getElementById('descripcion').value = producto.descripcion;
    document.getElementById('editar-index').dataset.index = index;
    // Cambiar texto del botón
    document.querySelector('[onclick="agregarProducto()"]').textContent = "Actualizar";
    // Mostrar botón de cancelar
    document.getElementById('cancelar-btn').style.display = 'inline-block';
}

        function eliminar(index) {
            productos.splice(index, 1);
            actualizarTabla();
        }

        function generarOrden() {
            const fechaInput = document.getElementById('fecha-actual');
            const fechaHeader = document.getElementById('fecha-input');
            
            fechaHeader.style.display = 'none';

            let fechaFormateada = '___________________';
            if(fechaInput.value) {
                const partesFecha = fechaInput.value.split('-');
                const year = partesFecha[0];
                const month = parseInt(partesFecha[1], 10) - 1;
                const day = partesFecha[2];
                
                const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
                const fechaManual = new Date(year, month, day);
                fechaFormateada = fechaManual.toLocaleDateString('es-VE', opciones);
            }

            const datos = {
                numero: `${document.getElementById('numero-orden').value || '000'}-${fecha.getFullYear()}`,
                senores: document.getElementById('senores').value,
                direccion: document.getElementById('direccion-orden').value,
                utilizadosPara: document.getElementById('utilizados-para').value,
                productos: productos,
                fecha: fechaFormateada
            };

            let productosHTML = '';
            for(let i = 0; i < 12; i++) {
                productosHTML += productos[i] 
                    ? `<tr><td>${productos[i].cantidad}</td><td>${productos[i].descripcion}</td></tr>`
                    : `<tr><td style="color:#999">-</td><td style="color:#999">-</td></tr>`;
            }

            const ordenHTML = `
                <div>
                    <h2 style="text-align: center; margin: 2mm 0; font-size: 11pt;">
                    ORDEN DE COMPRA N° ${datos.numero}
                    </h2>

                    <div style="text-align: right; margin-bottom: 3mm; font-size: 10pt;">
                    San José de Guaribe, ${datos.fecha}
                    </div>

                    <div style="margin: 2mm 0; font-size: 10pt;">
                        <p><strong>Señores:</strong> ${datos.senores || '__________________________'}</p>
                        <p><strong>Dirección:</strong> ${datos.direccion || '__________________________'}</p>
                    </div>

                    <p style="margin: 2mm 0; font-size: 10pt;"><strong>Sirvase en despachar por cuenta de esta ALCALDÍA MUNICIPAL; lo siguiente:</strong></p>

                    <table border="1" style="width:100%; margin:2mm 0; font-size: 9pt;">
                        <thead><tr><th style="width:15%">Cantidad</th><th>Descripción</th></tr></thead>
                        <tbody>${productosHTML}</tbody>
                    </table>

                    <div style="margin: 2mm 0; font-size: 10pt;">
                        <p><strong>Los cuales serán utilizados para:</strong></p>
                        <p>${datos.utilizadosPara || '______________________________________________________'}</p>
                    </div>

                    <div class="firmas-section" style="font-size: 9pt;">
                        <div style="width: 45%;">
                            <table style="width:100%;">
                                <tr><td colspan="2"><strong>AUTORIZADO POR:</strong></td></tr>
                                <tr><td>Nombre:</td><td>_________________________</td></tr>
                                <tr><td>Cargo:</td><td>_________________________</td></tr>
                                <tr><td>Firma:</td><td>_________________________</td></tr>
                            </table>
                        </div>
                        <div style="width: 45%;">
                            <table style="width:100%;">
                                <tr><td colspan="2"><strong>RECIBE CONFORME:</strong></td></tr>
                                <tr><td>Nombre:</td><td>_________________________</td></tr>
                                <tr><td>Cargo:</td><td>_________________________</td></tr>
                                <tr><td>Firma:</td><td>_________________________</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="no-print" style="text-align: center; margin-top: 3mm;">
                        <button onclick="cargarDatos()" class="boton-edicion">✏️ Editar</button>
                        <button onclick="window.print()" class="boton-edicion">🖨️ Imprimir</button>
                        <button onclick="location.reload()" class="boton-edicion"> Nueva</button>
                    </div>
                </div>
            `;

            document.getElementById('formulario').style.display = 'none';
            document.getElementById('orden-generada').innerHTML = ordenHTML;
            document.getElementById('orden-generada').style.display = 'block';
        }

        function cargarDatos() {
            document.getElementById('formulario').style.display = 'block';
            document.getElementById('orden-generada').style.display = 'none';
            document.getElementById('fecha-input').style.display = 'block';
        }
		
		function cancelarEdicion() {
    document.getElementById('cantidad').value = '';
    document.getElementById('descripcion').value = '';
    delete document.getElementById('editar-index').dataset.index;
    document.querySelector('[onclick="agregarProducto()"]').textContent = "➕";
    document.getElementById('cancelar-btn').style.display = 'none';
}
    </script>
	
	<script>
        (function() {
            const dominioPermitido = 'https://retencionesguaribe.github.io/compra.html';
            const urlActual = window.location.href;
            const tiempoEspera = 2000; // Tiempo de espera en milisegundos (2 segundos)
            const urlRedireccion = 'https://github.com/enterprise/advanced-security#pricing'; // URL de redirección personalizable
            const mensajeTexto = 'Esta página solo puede ejecutarse en el dominio autorizado. Serás redirigido...';

            if (window.location.protocol === 'file:' || !urlActual.startsWith(dominioPermitido)) {
                // Crear un mensaje en la página
                const mensaje = document.createElement('div');
                mensaje.className = 'mensaje-redireccion';
                mensaje.setAttribute('role', 'alert');
                mensaje.setAttribute('aria-live', 'assertive');
                mensaje.textContent = mensajeTexto;
                document.body.appendChild(mensaje);

                // Deshabilitar la página
                document.body.classList.add('deshabilitado');

                // Redirigir después de un breve retraso
                setTimeout(function() {
                    try {
                        window.location.href = urlRedireccion;
                    } catch (error) {
                        console.error("Error al redirigir:", error);
                        mensaje.textContent = 'Ocurrió un error al redirigir. Por favor, inténtalo de nuevo más tarde.';
                    }
                }, tiempoEspera);
            }
        })();
    </script>

<script>
    (function() {
        // Configuración personalizable
        const tiempoEspera = 2000; // 2 segundos de espera
        const urlRedireccion = 'index.html'; // Página de login
        const mensajeTexto = 'Debe iniciar sesión para acceder a esta página. Serás redirigido...';
        
        // Verificar si existe un usuario autenticado
        const usuario = JSON.parse(sessionStorage.getItem('usuario'));
        if (!usuario?.nombre) {
            
            // Crear mensaje de alerta
            const mensaje = document.createElement('div');
            mensaje.className = 'mensaje-redireccion';
            mensaje.setAttribute('role', 'alert');
            mensaje.setAttribute('aria-live', 'assertive');
            mensaje.textContent = mensajeTexto;
            document.body.appendChild(mensaje);

            // Deshabilitar interacción con la página
            document.body.classList.add('deshabilitado');

            // Agregar estilos necesarios
            const style = document.createElement('style');
            style.textContent = `
                .deshabilitado {
                    opacity: 0.5;
                    pointer-events: none;
                    transition: opacity 0.3s;
                }
                .mensaje-redireccion {
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    padding: 15px 25px;
                    background: #ff4444;
                    color: white;
                    border-radius: 5px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    z-index: 1000;
                }
            `;
            document.head.appendChild(style);

            // Redirigir después del tiempo de espera
            setTimeout(() => {
                try {
                    window.location.href = urlRedireccion;
                } catch (error) {
                    console.error("Error en la redirección:", error);
                    mensaje.textContent = 'Ocurrió un error. Por favor, intenta más tarde.';
                }
            }, tiempoEspera);
        }
    })();
</script>

<script>
    (function() {
        // Configuración
        const urlRedireccion = 'https://retencionesguaribe.github.io/compra.html';
        const tiempoEspera = 3000;
        
        // Obtener nombre de página normalizado
        const nombrePagina = window.location.pathname.split('/').pop()
            .split('?')[0] // Quitar parámetros
            .toLowerCase(); // Normalizar a minúsculas

        // Obtener permisos del usuario
        const usuario = JSON.parse(sessionStorage.getItem('usuario')) || {};
        const permisos = usuario.permisos || {};
        
        // Convertir claves de permisos a minúsculas y verificar
        const permisosLower = Object.keys(permisos).reduce((acc, key) => {
            acc[key.toLowerCase()] = permisos[key].toLowerCase();
            return acc;
        }, {});

        if (permisosLower[nombrePagina] !== 'si') {
            // Crear alerta
            const alerta = document.createElement('div');
            alerta.innerHTML = `
                <div class="alerta-seguridad">
                    <p>🚨 Acceso restringido: No tienes permiso para <strong>${nombrePagina}</strong></p>
                    <p>Redirigiendo al panel principal...</p>
                </div>
            `;
            
            // Estilos integrados
            const estilos = `
                .alerta-seguridad {
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fff3cd;
                    border: 2px solid #ffecb5;
                    color: #856404;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 9999;
                    text-align: center;
                    max-width: 90%;
                    animation: slideIn 0.5s ease-out;
                }
                @keyframes slideIn {
                    from { top: -100px; opacity: 0; }
                    to { top: 20px; opacity: 1; }
                }
            `;
            
            // Añadir elementos al DOM
            document.body.prepend(alerta);
            const styleTag = document.createElement('style');
            styleTag.textContent = estilos;
            document.head.appendChild(styleTag);

            // Bloquear interacción
            document.body.style.pointerEvents = 'none';
            
            // Redirigir después de 3 segundos
            setTimeout(() => {
                window.location.href = urlRedireccion;
            }, tiempoEspera);
        }
    })();
</script>
</body>
</html>
